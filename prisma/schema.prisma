// Duende Database Schema
// Based on product specification - a caring membrane between humans and their time

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?   // NextAuth uses 'image' not 'imageUrl'

  // NextAuth fields
  emailVerified DateTime?
  password      String?   // For email/password auth (hashed with bcrypt)

  // Location for weather-aware suggestions
  city          String?
  timezone      String    @default("America/New_York")

  // Google Calendar integration (read-only)
  googleAccessToken   String?
  googleRefreshToken  String?
  googleTokenExpiry   DateTime?

  // Onboarding & learning
  onboardingCompleted Boolean  @default(false)
  onboardedAt         DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]             // NextAuth OAuth accounts
  sessions      Session[]             // NextAuth sessions
  settings      UserSettings?
  intentions    Intention[]
  suggestions   Suggestion[]
  relationships Relationship[]
  calendarEvents CalendarEvent[]
  teachingsShown TeachingHistory[]

  @@index([email])
}

// NextAuth required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// DEFAULT SETTINGS - The Five Settings
// ============================================

model UserSettings {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // MOVEMENT SETTINGS
  movementTypes          String[]  // ["walking", "yoga", "gym", "dancing", "stretching", "swimming"]
  preferredMovementTime  String?   // "morning", "midday", "evening", "varies"
  enjoysOutdoors         Boolean   @default(true)
  allowsWalkingMeetings  Boolean   @default(true)

  // NUTRITION SETTINGS
  wantsProtectedLunch    Boolean   @default(true)
  preferredLunchTime     String?   // "12:00", "13:00", etc.
  eatsAtDesk             Boolean   @default(true) // current habit, not preference

  // RELATIONSHIPS SETTINGS
  // Close people stored in separate Relationship model

  // STRESS SETTINGS
  decompressMethods      String[]  // ["walks", "naps", "reading", "music", "quiet", "exercise"]
  maxMeetingHoursPerDay  Int       @default(6)
  wantsBufferTime        Boolean   @default(true)
  bufferMinutes          Int       @default(10)

  // TRANSCENDENCE SETTINGS
  passionProjects        String[]  // Free text describing projects
  learningGoals          String[]  // What they want to learn this year

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============================================
// RELATIONSHIPS - Close People
// ============================================

model Relationship {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name              String
  email             String?
  relationshipType  String   // "friend", "family", "partner", "close_colleague"
  isCloseConnection Boolean  @default(true)

  // Connection preferences
  desiredFrequency  String?  // "weekly", "biweekly", "monthly"
  energyImpact      String?  // "energizing", "neutral", "draining"

  // Tracking (for user insight only, no automated actions)
  lastContactDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([email])
}

// ============================================
// INTENTIONS - User Planning & Goal Setting
// ============================================
// User-created intentions for protecting their default settings
// These are aspirational goals the user sets, not automated actions

model Intention {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // What default setting does this protect?
  defaultSetting String // "movement", "nutrition", "relationships", "stress", "transcendence"

  // Intention details
  description    String
  weekStartDate  DateTime // Monday of the week

  // Status tracking (user manages this)
  status         String   @default("pending") // "pending", "scheduled", "completed", "dismissed"

  // When user plans to do this
  targetDay      String?  // "monday", "tuesday", etc.
  scheduledFor   DateTime?
  completedAt    DateTime?

  // Context for user planning
  requiresWeather Boolean  @default(false) // outdoor intentions
  requiresGap     Int?     // minutes needed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, weekStartDate])
  @@index([status])
}

// ============================================
// SUGGESTIONS - Educational Insights
// ============================================
// Renamed from advocacy to educational insights
// These help users understand calendar patterns, not to send messages on their behalf

model Suggestion {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // What type of insight?
  type           String // "too_many_meetings", "no_protected_lunch", "no_movement", "missing_buffers"

  // Context
  defaultSetting String? // Which of the 5 settings does this relate to?
  calendarEventId String? // Related calendar event if applicable

  // The insight content
  title          String
  description    String
  reasoning      String? // Educational explanation of why this pattern matters

  // Draft message removed - no longer sending messages on behalf of users
  draftMessage   String? // Deprecated field, will be removed in future migration

  // Teaching layer
  teachingText   String? // Educational content about the biology/science
  learnMoreUrl   String? // Link to resources

  // Status
  status         String   @default("pending") // "pending", "dismissed", "acknowledged"

  // User feedback
  acceptedAt     DateTime?
  dismissedAt    DateTime?
  sentAt         DateTime? // Deprecated field, will be removed
  feedbackNote   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiresAt DateTime? // Suggestions can expire if not acted upon

  @@index([userId, status])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// CALENDAR EVENTS - Cached from Google Calendar
// ============================================

model CalendarEvent {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Google Calendar data
  googleEventId String  @unique
  calendarId    String

  title         String?
  description   String?

  startTime     DateTime
  endTime       DateTime
  isAllDay      Boolean  @default(false)

  // Attendees
  attendees     Json?    // Array of {email, name, responseStatus}
  organizerEmail String?

  // Meeting metadata for analysis
  isRecurring   Boolean  @default(false)
  meetingLink   String?
  location      String?

  // Duende analysis (read-only)
  isProtected   Boolean  @default(false) // User manually protected this time

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, startTime])
  @@index([googleEventId])
}

// ============================================
// TEACHING HISTORY - Avoid Repetition
// ============================================

model TeachingHistory {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  defaultSetting String // "movement", "nutrition", "relationships", "stress", "transcendence"
  teachingKey    String // Unique key for the specific teaching
  teachingText   String

  // Tracking
  timesShown     Int      @default(1)
  lastShownAt    DateTime @default(now())

  createdAt DateTime @default(now())

  @@unique([userId, teachingKey])
  @@index([userId, defaultSetting])
}
